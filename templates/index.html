<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Compás</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:760px;margin:24px auto;padding:0 12px}
    textarea,input,button{font-size:16px}
    .box{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
    .reply{white-space:pre-wrap}
  </style>
</head>
<body>
  <h1>Compás</h1>

  <div class="box">
    <label>Passcode (if set): <input id="pass" type="password" placeholder="optional"/></label>
  </div>

  <div class="box">
    <textarea id="msg" rows="3" style="width:100%" placeholder="Type your situation..."></textarea>
    <button onclick="sendChat()">Send</button>
    <div id="out" class="reply"></div>
  </div>

  <div class="box">
    <h3>Daily reflection</h3>
    <button onclick="loadReflection()">New reflection</button>
    <div id="reflection-prompts"></div>
    <div id="kindness"></div>
    <textarea id="reflection-answers" rows="4" style="width:100%" placeholder="Write short notes here, one per line..."></textarea>
    <button onclick="saveReflection()">Save reflection</button>
    <div id="saved"></div>
  </div>

<script>
function headers() {
  const h = { "Content-Type": "application/json" };
  const pass = document.getElementById("pass").value.trim();
  if (pass) h["X-PASSCODE"] = pass;
  return h;
}

async function sendChat(){
  const res = await fetch("/chat", {
    method:"POST",
    headers: headers(),
    body: JSON.stringify({ message: document.getElementById("msg").value })
  });
  const data = await res.json();
  document.getElementById("out").textContent = data.reply || data.error || "(no reply)";
}

async function loadReflection(){
  const res = await fetch("/daily_reflection", { headers: headers() });
  const data = await res.json();
  if (data.error) { document.getElementById("reflection-prompts").textContent = data.error; return; }
  document.getElementById("reflection-prompts").innerHTML =
    data.prompts.map(p => `<p>• ${p}</p>`).join("");
  document.getElementById("kindness").innerHTML =
    `<p><strong>Connection idea:</strong> ${data.connection}</p>
     <p><strong>Exercise:</strong> ${data.kindness}</p>`;
}

async function saveReflection(){
  const answers = document.getElementById("reflection-answers").value.split("\n").filter(x=>x.trim());
  const res = await fetch("/daily_reflection", {
    method:"POST",
    headers: headers(),
    body: JSON.stringify({ user_id:"miguel", answers })
  });
  if (res.ok) { document.getElementById("saved").textContent = "Saved."; }
  else { document.getElementById("saved").textContent = "Error saving."; }
}
</script>
</body>
</html>
